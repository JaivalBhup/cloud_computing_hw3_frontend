<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Photo Search & Upload</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; background: #f7f9fc; color: #333; }
    h1 { text-align: center; margin-bottom: 40px; }
    h2 { margin-bottom: 10px; }
    .section { background: #fff; padding: 20px; margin-bottom: 30px; border-radius: 12px; box-shadow: 0 2px 6px rgba(0,0,0,0.1); }
    input[type="text"], input[type="file"] {
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 8px;
      width: 300px;
      max-width: 100%;
      margin-bottom: 10px;
    }
    button {
      padding: 10px 18px;
      background: #007bff;
      border: none;
      border-radius: 8px;
      color: white;
      cursor: pointer;
      font-size: 14px;
    }
    button:hover { background: #0056c7; }

    #results { display: flex; flex-wrap: wrap; gap: 15px; margin-top: 20px; justify-content: flex-start; }
    .photo { width: 220px; height: auto; border-radius: 10px; box-shadow: 0 2px 6px rgba(0,0,0,0.15); }
  </style>
    <script src="sdk/lib/axios/dist/axios.standalone.js"></script>
    <script src="sdk/lib/CryptoJS/rollups/sha256.js"></script>
    <script src="sdk/lib/CryptoJS/rollups/crypto-js.js"></script>
    <script src="sdk/lib/CryptoJS/components/hmac.js"></script>
    <script src="sdk/lib/CryptoJS/components/enc-base64.js"></script>
    <script src="sdk/lib/url-template/url-template.js"></script>
    <script src="sdk/lib/apiGatewayCore/sigV4Client.js"></script>
    <script src="sdk/lib/apiGatewayCore/apiGatewayClient.js"></script>
    <script src="sdk/lib/apiGatewayCore/simpleHttpClient.js"></script>
    <script src="sdk/lib/apiGatewayCore/utils.js"></script>

    <script src="sdk/apigClient.js"></script>
</head>
<body>
  <h1>Photo Search & Upload</h1>

  <div class="section">
    <h2>Search Photos</h2>
    <input id="searchQuery" type="text" placeholder="Enter search text" />
    <button onclick="searchPhotos()">Search</button>

    <div id="results"></div>
  </div>

  <div class="section">
    <h2>Upload Photo</h2>
    <input id="photoFile" type="file" accept="image/*" /><br /><br />
    <input id="customLabels" type="text" placeholder="Custom labels (comma separated)" /><br /><br />
    <button onclick="uploadPhoto()">Upload</button>
  </div>

  <script>
    const sdk = apigClientFactory.newClient();
    async function searchPhotos() {
      const q = document.getElementById('searchQuery').value;
      if (!q) return alert('Enter a search query');

      try {
        const res = await sdk.searchGet({ q });
        console.log(res);
        const resultsDiv = document.getElementById('results');
        resultsDiv.innerHTML = '';

        if (!res.data || !res.data.results) {
          resultsDiv.innerHTML = '<p>No results found.</p>';
          return;
        }

        res.data.results.forEach(url => {
          const img = document.createElement('img');
          img.src = url;
          img.className = 'photo';
          resultsDiv.appendChild(img);
        });
      } catch (err) {
        console.error(err);
        alert('Error performing search');
      }
    }

    async function uploadPhoto() {
      const fileInput = document.getElementById('photoFile');
      const labelsInput = document.getElementById('customLabels');

      if (!fileInput.files.length) return alert('Select a photo');

      const file = fileInput.files[0];
      const customLabels = labelsInput.value
        .split(',')
        .map(l => l.trim())
        .filter(l => l)
        .join(', ');

      try {
        // const fileContent = await readFileAsBinary(file);
        // console.log(fileContent);
         // Required by your SDK — custom labels belong in params
        const params = {
          "x-amz-meta-customLabels": customLabels,
          "filename": sanitizeFilename(file.name)
        };

      const additionalParams = {
        headers: {
          "Content-Type": file.type,
          "Accept": file.type
        }
      };


        const res = await sdk.uploadPut(params, file, additionalParams);
        alert('Upload successful');
      } catch (err) {
        console.error(err);
        alert('Upload failed');
      }
    }
    function sanitizeFilename(originalName) {
      // Remove file extension
      const ext = originalName.split('.').pop();

      // Strip non-alphanumeric characters
      const cleanBase = originalName
        .replace(/\.[^/.]+$/, "")      // remove extension
        .replace(/[^a-zA-Z0-9]/g, ""); // keep only A–Z, a–z, 0–9

      // If name becomes empty, generate a random one
      const finalBase = cleanBase || `file${Date.now()}`;

      return finalBase + "." + ext;
    }

    
    // Helper function to read file as binary
    function readFileAsBinary(file) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            
            reader.onload = (event) => {
                resolve(event.target.result);
            };
            
            reader.onerror = (error) => {
                reject(error);
            };
            
            reader.readAsArrayBuffer(file);
        });
    }
  </script>
</body>
</html>
